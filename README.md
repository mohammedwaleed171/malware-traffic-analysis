# malware-traffic-analysis | Wireshark
## Table of Contents
1.[Wireshark: Identifying Hosts and Users](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#wireshark-identifying-hosts-and-users)
  - [Host Information from Dynamic Host Configuration Protocol (DHCP) Traffic](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#host-information-from-dynamic-host-configuration-protocol-dhcp-traffic)
  - [Device Models and Operating System (OS) from HTTP Traffic](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#device-models-and-operating-system-os-from-http-traffic)
  - [Identifying Users in an Active Directory (AD) Environment](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#identifying-users-in-an-active-directory-ad-environment)
  - [Default Windows Hostnames](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#default-windows-hostnames)

## Wireshark: Identifying Hosts and Users

### Host Information from Dynamic Host Configuration Protocol (DHCP) Traffic
  - Any host generating traffic within a network should have three identifiers: a MAC address, an IP address and a hostname.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-2.jpeg" height="40%" width="40%" /><p/></p> <br/>
  - DHCP traffic might reveal the hostname using this IP address. First, type dhcp in the Wireshark filter bar to filter for DHCP traffic.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-3.jpeg" height="40%" width="40%" /><p/></p> <br/>
  - Select the first frame in the results, the one that displays DHCP Request in the Info column. Then go to the frame details section and expand the line for Dynamic Host Configuration Protocol (Request)
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-4.jpeg" height="40%" width="40%" /><p/></p> <br/>
  - Scroll down the frame details section, then expand the lines for Option: (50) Requested IP Address and Option: (12) Host Name. This reveals the client’s MAC address at f8:ff:c2:04:a5:7b with hostname         jeremiahs-MBP and a requested IP address of 172.16.1[.]38
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-5.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Host Information from NetBIOS Name Service (NBNS) Traffic
  -Depending on how frequently a DHCP lease is renewed, we might not have DHCP traffic in our pcap. Fortunately, we can use NBNS traffic to identify hostnames for computers running Microsoft Windows or         Apple hosts running macOS.
  -Filter on nbns for pcap and review details under the Info column. This should reveal the same hostname we previously found in the DHCP traffic, displaying JEREMIAHS-MBP.
   <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-6.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -Sane can followed for a windows host. This pcap is from a MAC address at 78:c2:3b:b8:93:e8 using an internal IP address of 172.16.1[.]101. The Windows hostname is DESKTOP-HVKYP4S.
   <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-7.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Device Models and Operating System (OS) from HTTP Traffic
  -Unencrypted HTTP traffic to a web browser can reveal the OS. This information is contained in the User-Agent line from the HTTP request headers.<br/>
  -In 2023, this method has become unreliable because browser developers are reducing information contained in the User-Agent line, so most up-to-date web browsers no longer report the actual OS version        used by the host.<br/>
  -While increasingly unreliable, this method can still help identify the platform type (Windows, Apple device, Linux or Android) from browser-generated unencrypted HTTP traffic.<br/>
  -A Windows host generated this traffic in an environment with both IPv4 and IPv6 enabled. We can find unencrypted web traffic to a web browser by filtering on http.accept_language. This reveals all HTTP       requests with an Accept-Language header line commonly generated by web browsers.<br/>
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-8.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This filter avoids web traffic generated by the OS and other applications, so we can focus on any unencrypted HTTP traffic generated by a browser. The results reveal several unencrypted HTTP GET             requests to outdoornebraska[.]gov over TCP port 80.<br/>
  -Select any of the HTTP GET requests to outdoornebraska[.]gov and follow the TCP stream.
     <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-9.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This TCP stream has HTTP request headers with a User-Agent line. This User-Agent line was generated by the Microsoft Edge web browser version 110.0.1587.69 from a Windows 11 host on March 10, 2023.
     <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-10.jpeg" height="40%" width="40%" /><p/></p> <br/>
     -Unencrypted HTTP web traffic generated by Android devices might also reveal the brand name and model of the device. Select the first HTTP GET request for www.pcapworkshop[.]net and follow the TCP stream.<br/>
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-12.jpeg" height="40%" width="40%" /><p/></p> <br/>
    -This activity was captured from a Google Pixel Android phone, and the web traffic to www.pcapworkshop[.]net was generated using Google’s Chrome browser for Android phones and tablets. The TCP stream for this web traffic, highlighting the User-Agent line that identifies the device and browser.<br/>
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-13.jpeg" height="40%" width="40%" /><p/></p> <br/>
    -Collected on May 14, 2023, this traffic reveals (Linux; Android 13; Pixel 4a (5G)) in the User-Agent line. Current versions of Chrome will now report this same device as (Linux; Android 10; K) because       of Google’s User-Agent reduction effort.<br/>
    -While User-Agent reduction applies to Android devices running Chrome or Chromium-based browsers, we did not notice any reduction when using the Safari browser on an Apple mobile device.<br/>
    -This activity was captured from an Apple iPhone running iOS 16.4.1, and the web traffic to www.pcapworkshop[.]net was generated using Apple’s Safari mobile web browser on April 10, 2023. The TCP stream for this web traffic is shown, highlighting the User-Agent line that identifies the device and OS version.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-15.jpeg" height="40%" width="40%" /><p/></p> <br/>
    
  #### Since more websites are using HTTPS, this method of host identification has become increasingly difficult, because HTTP headers and content are not visible in encrypted HTTPS traffic. However, fo those who find unencrypted HTTP web traffic during their investigation, this method can provide more information to help identify a host.<br/>

### Identifying Users in an Active Directory (AD) Environment
  -Perhaps the most important information when resolving an incident is determining the user associated with an infected host. For Windows clients in an AD environment, we can determine the user from user     account names in Kerberos traffic.<br/>
  #### This pcap is from a Windows host in the following AD environment:
      -Domain: www.pcapworkshop[.]net
      -Network segment: 172.16.1[.]0/24 (172.16.1[.]0 - 172.16.1[.]255)
      -Domain controller IP: 172.16.1[.]16
      -Domain controller hostname: PCAPWORKSHOP-DC
      -Segment gateway: 172.16.1[.]1
      -Broadcast address: 172.16.1[.]255
      -Windows client: 172.16.1[.]141
  
  -While this is an environment with both IPv4 and IPv6 enabled, the Kerberos traffic is IPv4 only.<br/>
  -Open the pcap in Wireshark and filter on kerberos.CNameString. Select the first frame. Go to the frame details section and expand the lines. Select the line with CNameString: desktop-hsjd5r8$ and apply     it as a column.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-16.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This will create a new column titled CNameString. Scroll down to the last frames in the column display. The CNameString column reveals a user account name for rene.mccollum in traffic between the domain     controller at 172.16.1[.]16 and the Windows client at 172.16.1[.]141
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-17.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -Besides Kerberos traffic, we might find a first and last name or other identifiers of the user in Lightweight Directory Access Protocol (LDAP) traffic. Use the following Wireshark filter:ldap contains       "CN=Users". This should reveal the string "CN=Rene McCollum, under the Info column
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-18.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Default Windows Hostnames

  -The default hostname for Windows 10 and Windows 11 computers is a 15-character string that starts with DESKTOP- and ends with seven random alpha-numeric characters.<br/>
  -Search for this identifier using ip contains "DESKTOP-" in the Wireshark filter. This finds the plaintext ASCII string DESKTOP- in any traffic at the IP layer or higher. For example, this search       would find if the string appears in TCP from SMB or Kerberos activity, but it also includes traffic that uses UDP like DNS or DHCP.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-19.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -An even better way to find the DESKTOP- string is to clear the Wireshark filter and use the Find Packet function under Wireshark’s Edit menu. This brings up Wireshark’s search panel immediately under       the search filter bar. Select “Packet Details” and “String” as our search options before typing desktop- as the search string.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-21.jpeg" height="40%" width="40%" /><p/></p> <br/>

### CONCLUSION
  -Properly identifying hosts and users from network traffic is essential when investigating an infected host. Following the methods from this tutorial, we can better utilize Wireshark to help identify affected hosts and users.


## Wireshark Tutorial: Exporting Objects from a Pcap

### Exporting Objects from HTTP Traffic

  -After filtering on http.request, find the two GET requests to smart-fax[.]com. The first request ends with .doc, indicating the first request returned a Microsoft Word document. The second request ends with .exe, indicating the second request returned a Windows executable file. The HTTP GET requests are listed below.<br/>
  smart-fax[.]com - GET /Documents/Invoice&MSO-Request.doc<br/>
  smart-fax[.]com - GET /knr.exe<br/>
-We can export these objects from the HTTP object list by using the menu path: File --> Export Objects --> HTTP...<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-1.png" height="40%" width="40%" /><p/></p> <br/>

-This menu path results in an Export HTTP object list window. Select the first line with smart-fax[.]com as the hostname and save it. Select the second line with smart-fax[.]com as the hostname and save it.
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-2.png" height="40%" width="40%" /><p/></p> <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-3.png" height="40%" width="40%" /><p/></p> <br/>

-Still, we should confirm these files are what we think they are. In a MacBook or Linux environment, you can use a terminal window or command line interface (CLI) for the following commands:<br/>
    file [filename] <br/>
    shasum -a 256 [filename] <br/>
-The file command returns the type of file. The shasum command will return the file hash, in this case the SHA256 file hash. <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-4.png" height="40%" width="40%" /><p/></p> <br/>
-The information above confirms our suspected Word document is in fact a Microsoft Word document. It also confirms the suspected Windows executable file is indeed a Windows executable. We can check the SHA256 hashes against VirusTotal to see if these files are detected as malware. We could also do a Google search on the SHA256 hashes to possibly find additional information.<br/>

-In addition to Windows executable or other malware files, we can also extract web pages. Our second pcap, contains traffic of someone entering login credentials on a fake PayPal login page.<br/>
-When reviewing network traffic from a phishing site, we might want to see what the phishing web page looks like. We can extract the initial HTML page using the Export HTTP object menu. Then we can view it through a web browser in an isolated environment.<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-5.png" height="40%" width="40%" /><p/></p> <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-6.png" height="40%" width="40%" /><p/></p> <br/>

### Exporting Objects from SMB Traffic
-Some malware uses Microsoft's Server Message Block (SMB) protocol to spread across an Active Directory (AD)-based network. A banking Trojan known as Trickbot added a worm module as early as July 2017 that uses an exploit based on EternalBlue to spread across a network over SMB. <br/>
-Our next pcap represents a Trickbot infection that used SMB to spread from an infected client at 10.6.26.110 to its domain controller at 10.6.26.6. Use the menu path File --> Export Objects --> SMB... <br/>
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-7.png" height="40%" width="40%" /><p/></p> <br/>
-This brings up an Export SMB object list, listing SMB objects you can export from the pcap
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-8.png" height="40%" width="40%" /><p/></p> <br/>

### Exporting Emails from SMTP Traffic
-Certain types of malware are designed to turn an infected Windows host into a spambot. These spambots send hundreds of spam messages or malicious emails every minute. In some cases, the messages are sent using unencrypted SMTP, and we can export these messages from a pcap of the infection traffic.<br/>
-In this pcap, an infected Windows client sends sextortion spam. Open the pcap in Wireshark, filter on smtp.data.fragment, and you should see 50 examples of subject lines. This happened in five seconds of network traffic from a single infected Windows host. We can export these messages using the menu path File --> Export Objects --> IMF...
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-9.png" height="40%" width="40%" /><p/></p> <br/>
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-10.png
" height="40%" width="40%" /><p/></p> <br/>
-The sextortion spam messages are all listed with an .eml file extension in the IMF object list
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-11.png" height="40%" width="40%" /><p/></p> <br/>
-After they are exported, these .eml files can be reviewed with an email client like Thunderbird, or they can be examined in a text editor
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-12.png" height="40%" width="40%" /><p/></p> <br/>


### Exporting files from FTP Traffic
-Some malware families use FTP during malware infections. Our next pcap has malware executables retrieved from an FTP server followed by information from the infected Windows host sent back to the same FTP server.<br/>
-Filter on ftp.request.command to review the FTP commands. We should find a username (USER) and password (PASS) followed by requests to retrieve (RETR) five Windows executable files: q.exe, w.exe, e.exe, r.exe, and t.exe. This is followed by requests to store (STOR) html-based log files back to the same FTP server approximately every 18 seconds.
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-13.png" height="40%" width="40%" /><p/></p> <br/>
-Now that we have an idea of the files that were retrieved and sent, we can review traffic from the FTP data channel using a filter for ftp-data
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-14.png" height="40%" width="40%" /><p/></p> <br/>
-We cannot use the Export Objects function in Wireshark to export these objects. However, we can follow the TCP stream from the data channels for each. Left-click on any of the lines that end with (SIZE q.exe) to select one of the TCP segments. Then right-click to bring up a menu and select the menu path for Follow --> TCP stream 
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-15.png" height="40%" width="40%" /><p/></p> <br/>
-This will bring up the TCP stream for q.exe over the FTP data channel. Near the bottom of the window is a button-style menu labeled "Show and save data as" which defaults to ASCII. Click on the menu and select "Raw"
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-16.png" height="40%" width="40%" /><p/></p> <br/>
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-17.png" height="40%" width="40%" /><p/></p> <br/>
-The window should now show hexadecimal characters instead of ASCII. Use the Save as... button near the bottom of the window to save this as a raw binary
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-18.png" height="40%" width="40%" /><p/></p> <br/>
-Save the file as q.exe. In a Linux or similar CLI environment, confirm this is a Windows executable file and get the SHA256 hash. The SHA256 hash shows a high detection rate as malware on VirusTotal. <br/>
    $ file q.exe
    q.exe: PE32 executable (GUI) Intel 80386, for MS Windows
    $ shasum -a 256 q.exe
    ca34b0926cdc3242bbfad1c4a0b42cc2750d90db9a272d92cfb6cb7034d2a3bd q.exe
    
### CONCLUSION
-Using the methods outlined, we can extract various objects from a pcap using Wireshark. This can be extremely helpful when we need to examine items from network traffic.




