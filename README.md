# malware-traffic-analysis | Wireshark
## Table of Contents
1. [Wireshark: Identifying Hosts and Users](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#wireshark-identifying-hosts-and-users)<br/>
    - [Host Information from Dynamic Host Configuration Protocol (DHCP) Traffic](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#host-information-from-dynamic-host-configuration-protocol-dhcp-traffic)<br/>
    - [Device Models and Operating System (OS) from HTTP Traffic](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#device-models-and-operating-system-os-from-http-traffic)<br/>
    - [Identifying Users in an Active Directory (AD) Environment](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#identifying-users-in-an-active-directory-ad-environment)<br/>
  - [Default Windows Hostnames](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#default-windows-hostnames)<br/>
  
2. [Wireshark Tutorial: Exporting Objects from a Pcap](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#wireshark-tutorial-exporting-objects-from-a-pcap)<br/>
    - [Exporting Objects from HTTP Traffic](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#exporting-objects-from-http-traffic)<br/>
    - [Exporting Objects from SMB Traffic](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#exporting-objects-from-smb-traffic)<br/>
    - [Exporting Emails from SMTP Traffic](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#exporting-emails-from-smtp-traffic)<br/>
    - [Exporting files from FTP Traffic](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#exporting-files-from-ftp-traffic)<br/>

3. [Wireshark: Examining Trickbot Infections](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#wireshark-examining-trickbot-infections) <br/>
      - [Trickbot from malspam](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#trickbot-from-malspam) <br/>
      - [Trickbot Distributed Through Other Malware](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#trickbot-distributed-through-other-malware) <br/>

4. [Wireshark: Decrypting HTTPS Traffic](https://github.com/mohammedwaleed171/malware-traffic-analysis/blob/main/README.md#wireshark-decrypting-https-traffic)


## Wireshark: Identifying Hosts and Users

### Host Information from Dynamic Host Configuration Protocol (DHCP) Traffic
  - Any host generating traffic within a network should have three identifiers: a MAC address, an IP address and a hostname.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-2.jpeg" height="40%" width="40%" /><p/></p> <br/>
  - DHCP traffic might reveal the hostname using this IP address. First, type dhcp in the Wireshark filter bar to filter for DHCP traffic.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-3.jpeg" height="40%" width="40%" /><p/></p> <br/>
  - Select the first frame in the results, the one that displays DHCP Request in the Info column. Then go to the frame details section and expand the line for Dynamic Host Configuration Protocol (Request)
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-4.jpeg" height="40%" width="40%" /><p/></p> <br/>
  - Scroll down the frame details section, then expand the lines for Option: (50) Requested IP Address and Option: (12) Host Name. This reveals the client’s MAC address at f8:ff:c2:04:a5:7b with hostname         jeremiahs-MBP and a requested IP address of 172.16.1[.]38
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-5.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Host Information from NetBIOS Name Service (NBNS) Traffic
  -Depending on how frequently a DHCP lease is renewed, we might not have DHCP traffic in our pcap. Fortunately, we can use NBNS traffic to identify hostnames for computers running Microsoft Windows or         Apple hosts running macOS.
  -Filter on nbns for pcap and review details under the Info column. This should reveal the same hostname we previously found in the DHCP traffic, displaying JEREMIAHS-MBP.
   <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-6.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -Sane can followed for a windows host. This pcap is from a MAC address at 78:c2:3b:b8:93:e8 using an internal IP address of 172.16.1[.]101. The Windows hostname is DESKTOP-HVKYP4S.
   <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-7.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Device Models and Operating System (OS) from HTTP Traffic
  -Unencrypted HTTP traffic to a web browser can reveal the OS. This information is contained in the User-Agent line from the HTTP request headers.<br/>
  -In 2023, this method has become unreliable because browser developers are reducing information contained in the User-Agent line, so most up-to-date web browsers no longer report the actual OS version        used by the host.<br/>
  -While increasingly unreliable, this method can still help identify the platform type (Windows, Apple device, Linux or Android) from browser-generated unencrypted HTTP traffic.<br/>
  -A Windows host generated this traffic in an environment with both IPv4 and IPv6 enabled. We can find unencrypted web traffic to a web browser by filtering on http.accept_language. This reveals all HTTP       requests with an Accept-Language header line commonly generated by web browsers.<br/>
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-8.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This filter avoids web traffic generated by the OS and other applications, so we can focus on any unencrypted HTTP traffic generated by a browser. The results reveal several unencrypted HTTP GET             requests to outdoornebraska[.]gov over TCP port 80.<br/>
  -Select any of the HTTP GET requests to outdoornebraska[.]gov and follow the TCP stream.
     <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-9.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This TCP stream has HTTP request headers with a User-Agent line. This User-Agent line was generated by the Microsoft Edge web browser version 110.0.1587.69 from a Windows 11 host on March 10, 2023.
     <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-10.jpeg" height="40%" width="40%" /><p/></p> <br/>
     -Unencrypted HTTP web traffic generated by Android devices might also reveal the brand name and model of the device. Select the first HTTP GET request for www.pcapworkshop[.]net and follow the TCP stream.<br/>
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-12.jpeg" height="40%" width="40%" /><p/></p> <br/>
    -This activity was captured from a Google Pixel Android phone, and the web traffic to www.pcapworkshop[.]net was generated using Google’s Chrome browser for Android phones and tablets. The TCP stream for this web traffic, highlighting the User-Agent line that identifies the device and browser.<br/>
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-13.jpeg" height="40%" width="40%" /><p/></p> <br/>
    -Collected on May 14, 2023, this traffic reveals (Linux; Android 13; Pixel 4a (5G)) in the User-Agent line. Current versions of Chrome will now report this same device as (Linux; Android 10; K) because       of Google’s User-Agent reduction effort.<br/>
    -While User-Agent reduction applies to Android devices running Chrome or Chromium-based browsers, we did not notice any reduction when using the Safari browser on an Apple mobile device.<br/>
    -This activity was captured from an Apple iPhone running iOS 16.4.1, and the web traffic to www.pcapworkshop[.]net was generated using Apple’s Safari mobile web browser on April 10, 2023. The TCP stream for this web traffic is shown, highlighting the User-Agent line that identifies the device and OS version.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-15.jpeg" height="40%" width="40%" /><p/></p> <br/>
    
  #### Since more websites are using HTTPS, this method of host identification has become increasingly difficult, because HTTP headers and content are not visible in encrypted HTTPS traffic. However, fo those who find unencrypted HTTP web traffic during their investigation, this method can provide more information to help identify a host.<br/>

### Identifying Users in an Active Directory (AD) Environment
  -Perhaps the most important information when resolving an incident is determining the user associated with an infected host. For Windows clients in an AD environment, we can determine the user from user     account names in Kerberos traffic.<br/>
  #### This pcap is from a Windows host in the following AD environment:
      -Domain: www.pcapworkshop[.]net
      -Network segment: 172.16.1[.]0/24 (172.16.1[.]0 - 172.16.1[.]255)
      -Domain controller IP: 172.16.1[.]16
      -Domain controller hostname: PCAPWORKSHOP-DC
      -Segment gateway: 172.16.1[.]1
      -Broadcast address: 172.16.1[.]255
      -Windows client: 172.16.1[.]141
  
  -While this is an environment with both IPv4 and IPv6 enabled, the Kerberos traffic is IPv4 only.<br/>
  -Open the pcap in Wireshark and filter on kerberos.CNameString. Select the first frame. Go to the frame details section and expand the lines. Select the line with CNameString: desktop-hsjd5r8$ and apply     it as a column.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-16.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This will create a new column titled CNameString. Scroll down to the last frames in the column display. The CNameString column reveals a user account name for rene.mccollum in traffic between the domain     controller at 172.16.1[.]16 and the Windows client at 172.16.1[.]141
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-17.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -Besides Kerberos traffic, we might find a first and last name or other identifiers of the user in Lightweight Directory Access Protocol (LDAP) traffic. Use the following Wireshark filter:ldap contains       "CN=Users". This should reveal the string "CN=Rene McCollum, under the Info column
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-18.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Default Windows Hostnames

  -The default hostname for Windows 10 and Windows 11 computers is a 15-character string that starts with DESKTOP- and ends with seven random alpha-numeric characters.<br/>
  -Search for this identifier using ip contains "DESKTOP-" in the Wireshark filter. This finds the plaintext ASCII string DESKTOP- in any traffic at the IP layer or higher. For example, this search       would find if the string appears in TCP from SMB or Kerberos activity, but it also includes traffic that uses UDP like DNS or DHCP.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-19.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -An even better way to find the DESKTOP- string is to clear the Wireshark filter and use the Find Packet function under Wireshark’s Edit menu. This brings up Wireshark’s search panel immediately under       the search filter bar. Select “Packet Details” and “String” as our search options before typing desktop- as the search string.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-21.jpeg" height="40%" width="40%" /><p/></p> <br/>

### CONCLUSION
  -Properly identifying hosts and users from network traffic is essential when investigating an infected host. Following the methods from this tutorial, we can better utilize Wireshark to help identify affected hosts and users.


## Wireshark Tutorial: Exporting Objects from a Pcap

### Exporting Objects from HTTP Traffic

  -After filtering on http.request, find the two GET requests to smart-fax[.]com. The first request ends with .doc, indicating the first request returned a Microsoft Word document. The second request ends with .exe, indicating the second request returned a Windows executable file. The HTTP GET requests are listed below.<br/>
  smart-fax[.]com - GET /Documents/Invoice&MSO-Request.doc<br/>
  smart-fax[.]com - GET /knr.exe<br/>
-We can export these objects from the HTTP object list by using the menu path: File --> Export Objects --> HTTP...<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-1.png" height="40%" width="40%" /><p/></p> <br/>

-This menu path results in an Export HTTP object list window. Select the first line with smart-fax[.]com as the hostname and save it. Select the second line with smart-fax[.]com as the hostname and save it.
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-2.png" height="40%" width="40%" /><p/></p> <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-3.png" height="40%" width="40%" /><p/></p> <br/>

-Still, we should confirm these files are what we think they are. In a MacBook or Linux environment, you can use a terminal window or command line interface (CLI) for the following commands:<br/>
    file [filename] <br/>
    shasum -a 256 [filename] <br/>
-The file command returns the type of file. The shasum command will return the file hash, in this case the SHA256 file hash. <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-4.png" height="40%" width="40%" /><p/></p> <br/>
-The information above confirms our suspected Word document is in fact a Microsoft Word document. It also confirms the suspected Windows executable file is indeed a Windows executable. We can check the SHA256 hashes against VirusTotal to see if these files are detected as malware. We could also do a Google search on the SHA256 hashes to possibly find additional information.<br/>

-In addition to Windows executable or other malware files, we can also extract web pages. Our second pcap, contains traffic of someone entering login credentials on a fake PayPal login page.<br/>
-When reviewing network traffic from a phishing site, we might want to see what the phishing web page looks like. We can extract the initial HTML page using the Export HTTP object menu. Then we can view it through a web browser in an isolated environment.<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-5.png" height="40%" width="40%" /><p/></p> <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-6.png" height="40%" width="40%" /><p/></p> <br/>

### Exporting Objects from SMB Traffic
-Some malware uses Microsoft's Server Message Block (SMB) protocol to spread across an Active Directory (AD)-based network. A banking Trojan known as Trickbot added a worm module as early as July 2017 that uses an exploit based on EternalBlue to spread across a network over SMB. <br/>
-Our next pcap represents a Trickbot infection that used SMB to spread from an infected client at 10.6.26.110 to its domain controller at 10.6.26.6. Use the menu path File --> Export Objects --> SMB... <br/>
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-7.png" height="40%" width="40%" /><p/></p> <br/>
-This brings up an Export SMB object list, listing SMB objects you can export from the pcap
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-8.png" height="40%" width="40%" /><p/></p> <br/>

### Exporting Emails from SMTP Traffic
-Certain types of malware are designed to turn an infected Windows host into a spambot. These spambots send hundreds of spam messages or malicious emails every minute. In some cases, the messages are sent using unencrypted SMTP, and we can export these messages from a pcap of the infection traffic.<br/>
-In this pcap, an infected Windows client sends sextortion spam. Open the pcap in Wireshark, filter on smtp.data.fragment, and you should see 50 examples of subject lines. This happened in five seconds of network traffic from a single infected Windows host. We can export these messages using the menu path File --> Export Objects --> IMF...
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-9.png" height="40%" width="40%" /><p/></p> <br/>
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-10.png" height="40%" width="40%" /><p/></p> <br/>
-The sextortion spam messages are all listed with an .eml file extension in the IMF object list
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-11.png" height="40%" width="40%" /><p/></p> <br/>
-After they are exported, these .eml files can be reviewed with an email client like Thunderbird, or they can be examined in a text editor
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-12.png" height="40%" width="40%" /><p/></p> <br/>


### Exporting files from FTP Traffic
-Some malware families use FTP during malware infections. Our next pcap has malware executables retrieved from an FTP server followed by information from the infected Windows host sent back to the same FTP server.<br/>
-Filter on ftp.request.command to review the FTP commands. We should find a username (USER) and password (PASS) followed by requests to retrieve (RETR) five Windows executable files: q.exe, w.exe, e.exe, r.exe, and t.exe. This is followed by requests to store (STOR) html-based log files back to the same FTP server approximately every 18 seconds.
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-13.png" height="40%" width="40%" /><p/></p> <br/>
-Now that we have an idea of the files that were retrieved and sent, we can review traffic from the FTP data channel using a filter for ftp-data
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-14.png" height="40%" width="40%" /><p/></p> <br/>
-We cannot use the Export Objects function in Wireshark to export these objects. However, we can follow the TCP stream from the data channels for each. Left-click on any of the lines that end with (SIZE q.exe) to select one of the TCP segments. Then right-click to bring up a menu and select the menu path for Follow --> TCP stream 
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-15.png" height="40%" width="40%" /><p/></p> <br/>
-This will bring up the TCP stream for q.exe over the FTP data channel. Near the bottom of the window is a button-style menu labeled "Show and save data as" which defaults to ASCII. Click on the menu and select "Raw"
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-16.png" height="40%" width="40%" /><p/></p> <br/>
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-17.png" height="40%" width="40%" /><p/></p> <br/>
-The window should now show hexadecimal characters instead of ASCII. Use the Save as... button near the bottom of the window to save this as a raw binary
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/07/word-image-18.png" height="40%" width="40%" /><p/></p> <br/>
-Save the file as q.exe. In a Linux or similar CLI environment, confirm this is a Windows executable file and get the SHA256 hash. The SHA256 hash shows a high detection rate as malware on VirusTotal. <br/>
    $ file q.exe <br/>
    q.exe: PE32 executable (GUI) Intel 80386, for MS Windows <br/>
    $ shasum -a 256 q.exe <br/>
    ca34b0926cdc3242bbfad1c4a0b42cc2750d90db9a272d92cfb6cb7034d2a3bd q.exe <br/>
    
### CONCLUSION
-Using the methods outlined, we can extract various objects from a pcap using Wireshark. This can be extremely helpful when we need to examine items from network traffic.

## Wireshark: Examining Trickbot Infections
-Trickbot, an information stealer and banking malware that has been infecting victims since 2016. Trickbot is distributed through malicious spam (malspam), and it is also distributed by other malware such as Emotet, IcedID, or Ursnif.<br/>

### Trickbot from malspam: 
-Trickbot is often distributed through malspam. Emails from these campaigns contain links to download malicious files disguised as invoices or documents. These files may be Windows executable files for Trickbot, or they may be some sort of downloader for the Trickbot executable. In some cases, links from these emails return a zip archive that contains a Trickbot executable or downloader.<br/>
-In this example, the email contained a link that returned a zip archive. The zip archive contained a Windows shortcut file that downloaded a Trickbot executable. <br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-61-1024x554.png" height="40%" width="40%" /><p/></p> <br/>

-Review the traffic, and you will find the following activity common in recent Trickbot infections:<br/>
  - An IP address check by the infected Windows host<br/>
  - HTTPS/SSL/TLS traffic over TCP ports 447 and 449<br/>
  - HTTP traffic over TCP port 8082<br/>
  - HTTP requests ending in .png that return Windows executable files<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-63-1024x570.png" height="40%" width="40%" /><p/></p> <br/>

-Unique to this Trickbot infection is an HTTP request to www.dchristjan[.]com that returned a zip archive and an HTTP request to 144.91.69[.]195 that returned a Windows executable file. Follow the HTTP stream for the request to www.dchristjan[.]com to review the traffic. In the HTTP stream, you will find indicators that a zip archive was returned <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-65-1024x580.png" height="40%" width="40%" /><p/></p> <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-67-1024x796.png" height="40%" width="40%" /><p/></p> <br/>
-We can also see the name of the file contained in the zip archive, InvoiceAndStatement.lnk. We can export the zip archive from the traffic using Wireshark as shown using the following path:<br/>
    - File → Export Objects → HTTP…<br/>
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-69-1024x573.png" height="40%" width="40%" /><p/></p> <br/>
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-70.png" height="40%" width="40%" /><p/></p> <br/>
-Get the SHA256 hash of the file, and extract the contents of the archive in a command line environment. In this case, the content is a Windows shortcut file, which you can also confirm and get the SHA256 hash<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-72-1024x520.png" height="40%" width="40%" /><p/></p> <br/>
-An HTTP request to 144.91.69[.]195 returned a Windows executable file. This is the initial Windows executable for Trickbot. We can follow the HTTP stream for this HTTP request and find indicators this is an executable file. We can extract the executable file from the pcap.<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-73-1024x706.png" height="40%" width="40%" /><p/></p> <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-74-1024x755.png" height="40%" width="40%" /><p/></p> <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-75-1024x546.png" height="40%" width="40%" /><p/></p> <br/>

-Post infection traffic initially consists of HTTPS/SSL/TLS traffic over TCP port 443, 447, or 449 and an IP address check by the infected Windows host. In this infection, shortly after the HTTP request for the Trickbot executable, we can see several attempted TCP connections over port 443 to different IP addresses before the successful TCP connection to 187.58.56[.]26 over TCP port 449.
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-76-1024x704.png" height="40%" width="40%" /><p/></p> <br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-77-1024x705.png" height="40%" width="40%" /><p/></p> <br/>
-The HTTPS/SSL/TLS traffic to various IP addresses over TCP port 447 and TCP port 449 has unusual certificate data. We can review the certificate issuer by filtering on ssl.handshake.type == 11 when using Wireshark 2.x or tls.handshake.type == 11 when using Wireshark 3.x. Then go to the frame details section and expand the information, finding your way to the certificate issuer data
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-79-1024x704.png" height="40%" width="40%" /><p/></p> <br/>

-we see the following certificate issuer data used in HTTPS/SSL/TLS traffic to 187.58.56[.]26 over TCP port 449:<br/>
  - id-at-countryName=AU<br/>
  - id-at-stateOrProvinceName=Some-State<br/>
  - id-at-organizationName=Internet Widgits Pty Ltd<br/>

-The state or province name (Some-State) and the organization name (Internet Widgits Pty Ltd) are not used for legitimate HTTPS/SSL/TLS traffic. This is an indicator of malicious traffic, and this type of unusual certificate issuer data is not limited to Trickbot. <br/>
-What does a normal certificate issuer look like in legitimate HTTPS/SSL/TLS traffic? If we look at earlier traffic to Microsoft domains at 72.21.81.200 over TCP port 443, we find the following,<br/>
  - id-at-countryName=US<br/>
  - id-at-stateOrProvinceName=Washington<br/>
  - id-at-localityName=Redmond<br/>
  - id-at-organizationName=Microsoft Corporation<br/>
  - id-at-organizationUnitName=Microsoft IT<br/>
  - id-at-commonName=Microsoft IT TLS CA 2<br/>
  
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-80-1024x586.png" height="40%" width="40%" /><p/></p> <br/>

-A Trickbot infection currently generates HTTP traffic over TCP port 8082 this traffic sends information from the infected host like system information and passwords from the browser cache and email clients. This information is sent from the infected host to command and control servers used by Trickbot. <br/>
-To review this traffic, use the following Wireshark filter:<br/>
    - http.request and tcp.port eq 8082  <br/>
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-82-1024x362.png" height="40%" width="40%" /><p/></p> <br/>
-HTTP POST requests ending in 81 send cached password data from web browsers, email clients, and other applications. HTTP POST requests ending in 83 send form data submitted by applications like web browsers. We can find system information sent through HTTP POST requests ending in 90. Follow the TCP or HTTP streams for any of these HTTP POST requests to review data stolen by this infection.<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-83-1024x804.png" height="40%" width="40%" /><p/></p> <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-84-1024x806.png" height="40%" width="40%" /><p/></p> <br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-85-1024x802.png" height="40%" width="40%" /><p/></p> <br/>

-Trickbot sends more Windows executable files over HTTP GET requests ending in .png. These follow-up Trickbot executables are used to infect a vulnerable domain controller (DC) when the infected Windows host is a client in an Active Directory environment.<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-86-1024x304.png" height="40%" width="40%" /><p/></p> <br/>
-Follow the TCP or HTTP stream in each of the three requests. We should see indicators of windows executable files. However, in this case, the HTTP response headers identify the returned file as image/png even though it clearly is a Windows executable or DLL file. We can export these files from Wireshark, confirm they are Windows executable files, and get the SHA256 file hashes as we covered earlier<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-87-1024x747.png" height="40%" width="40%" /><p/></p> <br/>


### Trickbot Distributed Through Other Malware:

-Trickbot is frequently distributed through other malware. Trickbot is commonly seen as follow-up malware to Emotet infections, but we have also seen it as follow-up malware from IcedID and Ursnif infections<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-88-1024x382.png" height="40%" width="40%" /><p/></p> <br/>
-Post-infection Emotet activity consists HTTP traffic with encoded data returned by the server. This is distinctly different than post-infection Trickbot activity which generally relies on HTTPS/SSL/TLS traffic for command and control communications.<br/>
  <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-90-1024x586.png" height="40%" width="40%" /><p/></p> <br/>
-This infection happened in an Active Directory environment with 10.9.25.102 as the infected Windows client and 10.9.25.9 as the DC. Later in the traffic, we see the DC exhibit signs of Trickbot infection<br/>
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-91-1024x535.png" height="40%" width="40%" /><p/></p> <br/>
-How did the infection move from client to DC? Trickbot uses a version of the EternalBlue exploit to move laterally using Microsoft’s SMB protocol. In this case, the infected Windows client sent information several times over TCP port 445 to the DC at 10.9.25.9, which then retrieved a Trickbot executable from 185.98.87[.]185/wredneg2.png.
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-92-1024x703.png" height="40%" width="40%" /><p/></p> <br/>
-Follow one of the TCP streams, for example the line with a source as 10.9.25.102 over TCP port 49321 and destination as 10.9.35.9 over TCP port 445. This is highly unusual traffic for a client to send to a DC, so it is likely related to the EternalBlue exploit.
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/11/word-image-93-1024x725.png" height="40%" width="40%" /><p/></p> <br/>

## Wireshark: Decrypting HTTPS Traffic
-When reviewing suspicious network activity, we often run across encrypted traffic. Why? Because most websites use the Hypertext Transfer Protocol Secure (HTTPS) protocol. But like most websites, various types of malware also use HTTPS. When reviewing pcaps from malware activity, it’s very helpful to know what’s contained within post-infection traffic.<br/>
-Decryption is possible with a text-based log containing encryption key data captured when the pcap was originally recorded. With this key log file, we can decrypt HTTPS activity in a pcap and review its contents.<br/>
-We will examine HTTPS activity from a Dridex malware infection.<br/>
-The most common protocol used by websites was Hypertext Transfer Protocol (HTTP), which generated unencrypted web traffic. However, as security became an increasing concern, websites started switching to HTTPS, and now we rarely see HTTP traffic from web browsing. HTTPS is essentially an encrypted communications tunnel containing HTTP traffic. These tunnels first used Secure Sockets Layer (SSL) as an encryption protocol. Today most HTTPS traffic uses Transport Layer Security (TLS). <br/>

### HTTPS Web Traffic
-HTTPS traffic often reveals a domain name. For example, when viewing https://www.wireshark.org in a web browser, a pcap would show www.wireshark.org as the server name for this traffic when viewed in a customized Wireshark column display. Unfortunately, we don’t know other details like the actual URL or data returned from the server. Following the Transmission Control Protocol (TCP) stream from a pcap will not reveal the content of this traffic because it is encrypted.<br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image.jpeg" height="40%" width="40%" /><p/></p> <br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image-1.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Encryption Key Log File
-An encryption key log is a text file. These logs are created using a Man in the Middle (MitM) technique when the pcap is originally recorded. If no such file was created when the pcap was recorded, We cannot decrypt HTTPS traffic in that pcap.<br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image-2.jpeg" height="40%" width="40%" /><p/></p> <br/>

### HTTPS Traffic Without the Key Log File
-This pcap is from a Dridex malware infection on a Windows 10 host. All web traffic, including the infection activity, is HTTPS. Without the key log file, we cannot see any details of the traffic, just the IP addresses, TCP ports and domain names <br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image-6.jpeg" height="40%" width="40%" /><p/></p> <br/>

 ### HTTPS Traffic With the Key Log File
<p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image-12.jpeg" height="40%" width="40%" /><p/></p> <br/>

-In this pcap, we now see HTTP requests to microsoft.com and skype.com domains previously hidden in the HTTPS traffic. We also find the following traffic caused by the Dridex infection:<br/>
 - foodsgoodforliver[.]com - GET /invest_20.dll<br/>
 - 105711[.]com - POST /docs.php<br/>
-The GET request to foodsgoodforliver[.]com returned a DLL file for Dridex. The POST requests to 105711[.]com are command and control (C2) traffic from the Dridex-infected Windows host.<br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image-13.jpeg" height="40%" width="40%" /><p/></p> <br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image-14.jpeg" height="40%" width="40%" /><p/></p> <br/>
-Since we have the key log file for this traffic, we can now export this malware from the pcap. Use the menu path File --> Export Objects --> HTTP to export this file from the pcap<br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image-15.jpeg" height="40%" width="40%" /><p/></p> <br/>
-The SHA256 hash of this malware is: 31cf42b2a7c5c558f44cfc67684cc344c17d4946d3a1e0b2cecb8eb58173cb2f<br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image-16.jpeg" height="40%" width="40%" /><p/></p> <br/>
 -We can review C2 traffic from this Dridex infection. Follow an HTTP stream from one of the POST requests to 105711[.]com. An example from one of the HTTP streams<br/>
 <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/08/word-image-17.jpeg" height="40%" width="40%" /><p/></p> <br/>

 ### Conclusion
 -We reviewed how to decrypt HTTPS traffic in a pcap with Wireshark using a key log text file. Without a key log file created when the pcap was originally recorded, you cannot decrypt HTTPS traffic from that pcap in Wireshark.







