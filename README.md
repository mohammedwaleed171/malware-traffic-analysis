# malware-traffic-analysis | Wireshark

## Wireshark: Identifying Hosts and Users

### Host Information from Dynamic Host Configuration Protocol (DHCP) Traffic
  - Any host generating traffic within a network should have three identifiers: a MAC address, an IP address and a hostname.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-2.jpeg" height="40%" width="40%" /><p/></p> <br/>
  - DHCP traffic might reveal the hostname using this IP address. First, type dhcp in the Wireshark filter bar to filter for DHCP traffic.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-3.jpeg" height="40%" width="40%" /><p/></p> <br/>
  - Select the first frame in the results, the one that displays DHCP Request in the Info column. Then go to the frame details section and expand the line for Dynamic Host Configuration Protocol (Request)
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-4.jpeg" height="40%" width="40%" /><p/></p> <br/>
  - Scroll down the frame details section, then expand the lines for Option: (50) Requested IP Address and Option: (12) Host Name. This reveals the client’s MAC address at f8:ff:c2:04:a5:7b with hostname         jeremiahs-MBP and a requested IP address of 172.16.1[.]38
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-5.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Host Information from NetBIOS Name Service (NBNS) Traffic
  -Depending on how frequently a DHCP lease is renewed, we might not have DHCP traffic in our pcap. Fortunately, we can use NBNS traffic to identify hostnames for computers running Microsoft Windows or         Apple hosts running macOS.
  -Filter on nbns for pcap and review details under the Info column. This should reveal the same hostname we previously found in the DHCP traffic, displaying JEREMIAHS-MBP.
   <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-6.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -Sane can followed for a windows host. This pcap is from a MAC address at 78:c2:3b:b8:93:e8 using an internal IP address of 172.16.1[.]101. The Windows hostname is DESKTOP-HVKYP4S.
   <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-7.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Device Models and Operating System (OS) from HTTP Traffic
  -Unencrypted HTTP traffic to a web browser can reveal the OS. This information is contained in the User-Agent line from the HTTP request headers.
  -In 2023, this method has become unreliable because browser developers are reducing information contained in the User-Agent line, so most up-to-date web browsers no longer report the actual OS version        used by the host.
  -While increasingly unreliable, this method can still help identify the platform type (Windows, Apple device, Linux or Android) from browser-generated unencrypted HTTP traffic.
  -A Windows host generated this traffic in an environment with both IPv4 and IPv6 enabled. We can find unencrypted web traffic to a web browser by filtering on http.accept_language. This reveals all HTTP       requests with an Accept-Language header line commonly generated by web browsers.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-8.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This filter avoids web traffic generated by the OS and other applications, so we can focus on any unencrypted HTTP traffic generated by a browser. The results reveal several unencrypted HTTP GET             requests to outdoornebraska[.]gov over TCP port 80.
  -Select any of the HTTP GET requests to outdoornebraska[.]gov and follow the TCP stream.
     <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-9.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This TCP stream has HTTP request headers with a User-Agent line. This User-Agent line was generated by the Microsoft Edge web browser version 110.0.1587.69 from a Windows 11 host on March 10, 2023.
     <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-10.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -Unencrypted HTTP web traffic generated by Android devices might also reveal the brand name and model of the device. Select the first HTTP GET request for www.pcapworkshop[.]net and follow the TCP stream.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-12.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This activity was captured from a Google Pixel Android phone, and the web traffic to www.pcapworkshop[.]net was generated using Google’s Chrome browser for Android phones and tablets. The TCP stream for     this web traffic is shown below in Figure 13, highlighting the User-Agent line that identifies the device and browser.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-13.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -Collected on May 14, 2023, this traffic reveals (Linux; Android 13; Pixel 4a (5G)) in the User-Agent line. Current versions of Chrome will now report this same device as (Linux; Android 10; K) because       of Google’s User-Agent reduction effort.
  -While User-Agent reduction applies to Android devices running Chrome or Chromium-based browsers, we did not notice any reduction when using the Safari browser on an Apple mobile device.
  -This activity was captured from an Apple iPhone running iOS 16.4.1, and the web traffic to www.pcapworkshop[.]net was generated using Apple’s Safari mobile web browser on April 10, 2023. The TCP stream      for this web traffic is shown, highlighting the User-Agent line that identifies the device and OS version.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-15.jpeg" height="40%" width="40%" /><p/></p> <br/>
    
  ####Since more websites are using HTTPS, this method of host identification has become increasingly difficult, because HTTP headers and content are not visible in encrypted HTTPS traffic. However, fo those who find unencrypted HTTP web traffic during their investigation, this method can provide more information to help identify a host.

### Identifying Users in an Active Directory (AD) Environment
  -Perhaps the most important information when resolving an incident is determining the user associated with an infected host. For Windows clients in an AD environment, we can determine the user from user     account names in Kerberos traffic.
  ###This pcap is from a Windows host in the following AD environment:
      -**Domain**: www.pcapworkshop[.]net
      -**Network segmen**t: 172.16.1[.]0/24 (172.16.1[.]0 - 172.16.1[.]255)
      -**Domain controller IP**: 172.16.1[.]16
      -**Domain controller hostname**: PCAPWORKSHOP-DC
      -**Segment gateway**: 172.16.1[.]1
      -**Broadcast address**: 172.16.1[.]255
      -**Windows client**: 172.16.1[.]141
  
  -While this is an environment with both IPv4 and IPv6 enabled, the Kerberos traffic is IPv4 only.
  -Open the pcap in Wireshark and filter on kerberos.CNameString. Select the first frame. Go to the frame details section and expand the lines. Select the line with CNameString: desktop-hsjd5r8$ and apply     it as a column.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-16.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -This will create a new column titled CNameString. Scroll down to the last frames in the column display. The CNameString column reveals a user account name for rene.mccollum in traffic between the domain     controller at 172.16.1[.]16 and the Windows client at 172.16.1[.]141
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-17.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -Besides Kerberos traffic, we might find a first and last name or other identifiers of the user in Lightweight Directory Access Protocol (LDAP) traffic. Use the following Wireshark filter:ldap contains       "CN=Users". This should reveal the string "CN=Rene McCollum, under the Info column
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-18.jpeg" height="40%" width="40%" /><p/></p> <br/>

### Default Windows Hostnames

  -The default hostname for Windows 10 and Windows 11 computers is a 15-character string that starts with DESKTOP- and ends with seven random alpha-numeric characters.
  -Search for this identifier using ip contains "DESKTOP-" in the Wireshark filter. This finds the plaintext ASCII string DESKTOP- in any traffic at the IP layer or higher. For example,      this search       would find if the string appears in TCP from SMB or Kerberos activity, but it also includes traffic that uses UDP like DNS or DHCP.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-19.jpeg" height="40%" width="40%" /><p/></p> <br/>
  -An even better way to find the DESKTOP- string is to clear the Wireshark filter and use the Find Packet function under Wireshark’s Edit menu. This brings up Wireshark’s search panel immediately under       the search filter bar. Select “Packet Details” and “String” as our search options before typing desktop- as the search string.
    <p align="center"><img src="https://unit42.paloaltonetworks.com/wp-content/uploads/2023/10/word-image-130507-21.jpeg" height="40%" width="40%" /><p/></p> <br/>

### CONCLUSION
  -Properly identifying hosts and users from network traffic is essential when investigating an infected host. Following the methods from this tutorial, we can better utilize Wireshark to help identify affected hosts and users.
    

